{% extends "mainApp/HTML/base.html" %}
{% load static%}

{% block styles %}
    <link type="text/css" rel="stylesheet" href="{% static 'projectsApp\CSS\project.css'%}">
{% endblock %}

{% block main %}
    <div class="base-container">
        <div class="side-menu">
            {% if request.user.is_authenticated %}
                <p> Ваши проекты: </p>
                {% if projects %}
                    {% for project in projects %}
                        <a href="{% url 'project' project.project.title %}" class="a-btn project-btn">
                            <div>
                                {{project.project.title}}
                            </div>
                        </a>
                    {% endfor %}
                {% else %}
                    <p> Вы ещё не состоите ни в каком проекте </p>
                {% endif %}
                <button type="submit" class="a-btn project-btn" id="btnShowModal">+</button>
            {% else %}
                <p>Пожалуйста, авторизуйтесь на сайте для просмотра ваших проектов</p>
            {% endif %}
        </div>
        <div class="main-container">
            {% if request.user.is_authenticated %}
                {% if title_project %}
                    <div>
                        <button id="addTask"> Добавить задачу</button>
                    </div>
                    {% for task in tasks_project %}
                        <div class="task-container" id="task-container-{{ forloop.counter }}">
                            <div class="title">{{ task.title }}</div>
                            <div >
                                {% if task.comment == '' %}
                                    Нет комментариев
                                {% else %}
                                    Комментарий
                                {% endif %}
                            </div>
                            <div> Дедлайн: {{task.deadline}}</div>
                            <div class="worker" id="worker">
                                {% if task.user is None %}
                                    Нет исполнителя
                                    <form class="getWorkForm" method="post" action="{% url 'project' title_project %}">
                                        {% csrf_token %}
                                        <input type="hidden" name="task-id" value="{{task.pk}}">
                                        <input type="hidden" name="container-id" value="{{ forloop.counter0 }}">
                                        <button type="submit" class="btn">Взять на исполнение</button>
                                    </form>
                                {% else %}
                                    Исполнитель: {{task.user}}
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    Выберите проект
                {% endif %}
            {% else %}
                <p>Пожалуйста, авторизуйтесь на сайте для просмотра ваших проектов</p>
            {% endif %}
        </div>
    </div>
    <dialog id="modal">
        <form method="post" id="addProject" action="{% url 'addProject' %}">{% csrf_token %}</form>
        <label>Название проекта:</label>
        <input type="text" form="addProject" name="title"/> <br>
        <div class="modal-btn">
            <button type="submit" form="addProject" class="a-btn project-btn">Создать проект</button>
            <button type="submit" class="a-btn project-btn">Отмена</button>
        </div>
    </dialog>
{% endblock %}

{% block js %}
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
        $(".getWorkForm").each(function(index, element) {
            $(element).submit(function(){
                $.ajax({
                    data: $(this).serialize(),
                    type: 'POST',
                    url:  $(this).attr('action'),
                    success: function (response) {
                        element.parentElement.innerHTML = 'Исполнитель: {{request.user.username}}';
                    },
                    error: function (response) {
                        alert("Что-то пошло не так. Попробуйте позже.");
                        console.log(response.responseJSON.errors)
                    }
                });
                return false;
            });
        })

        const modalElement = document.getElementById("modal");
        $("#addProject").submit(function(e){
            $.ajax({
                data: $(this).serialize(),
                type: 'POST',
                url:  $(this).attr('action'),
                success: function(response){
                    modalElement.close();
                    let btn = document.getElementById('btnShowModal');

                    let newBtn = document.createElement('a');
                    newBtn.setAttribute('class', 'a-btn project-btn');
                    newBtn.setAttribute('href', response.title + '/');
                    newBtn.innerHTML = response.title;

                    parent = btn.parentElement;
                    parent.insertBefore(newBtn, btn);
                }
            });
            return false;
        });


        document.getElementById("btnShowModal").onclick = function(){
            modalElement.showModal();
        }

    </script>
{% endblock %}